# syntax=docker/dockerfile:1.3

ARG GO_VERSION=1.16.8

FROM golang:${GO_VERSION}-alpine AS golang
ENV  CGO_ENABLED=0

FROM golang AS gotestsum
ARG GOTESTSUM_VERSION=v0.4.0
RUN --mount=type=cache,target=/root/.cache/go-build \
    --mount=type=cache,target=/go/pkg/mod \
    --mount=type=tmpfs,target=/go/src/ \
    GO111MODULE=on go install gotest.tools/gotestsum@${GOTESTSUM_VERSION}

FROM golang AS dev
RUN  apk add --no-cache \
    bash \
    build-base \
    ca-certificates \
    coreutils \
    curl \
    git

CMD bash
ENV DISABLE_WARN_OUTSIDE_CONTAINER=1
ENV PATH=$PATH:/src/build

COPY --from=gotestsum /go/bin/* /go/bin/

WORKDIR /src
ENV GO111MODULE=auto
COPY . .
