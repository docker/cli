#!/usr/bin/env bash
#
# Build a binary for all supported platforms
#

set -eu -o pipefail

BUILDDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export SHELL=bash

# Outside of circleCI run all at once. On circleCI run two at a time because
# each continer has access to two cores.
group=${CROSS_GROUP-"all"}

if [ "$group" == "all" ]; then

  echo "Building binaries for all platforms"
  parallel ::: \
      "$BUILDDIR/windows" \
      "$BUILDDIR/osx" \
      "GOOS=linux GOARCH=amd64   $BUILDDIR/binary" \
      "GOOS=linux GOARCH=arm     $BUILDDIR/binary" \
      "GOOS=linux GOARCH=ppc64le $BUILDDIR/binary" \
      "GOOS=linux GOARCH=s390x   $BUILDDIR/binary" \
    ;

elif [ "$group" == "0" ]; then

    parallel ::: \
        "$BUILDDIR/windows" \
        "$BUILDDIR/osx" \
    ;

elif [ "$group" == "1" ]; then

    parallel ::: \
        "GOOS=linux GOARCH=amd64   $BUILDDIR/binary" \
        "GOOS=linux GOARCH=arm     $BUILDDIR/binary" \
    ;

elif [ "$group" == "2" ]; then

    parallel ::: \
        "GOOS=linux GOARCH=ppc64le $BUILDDIR/binary" \
        "GOOS=linux GOARCH=s390x   $BUILDDIR/binary" \
    ;

fi
